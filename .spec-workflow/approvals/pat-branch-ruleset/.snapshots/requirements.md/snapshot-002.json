{
  "id": "snapshot_1771658555618_2vh06cnw7",
  "approvalId": "approval_1771658429178_gcw8ca1y4",
  "approvalTitle": "Requirements: pat-branch-ruleset",
  "version": 2,
  "timestamp": "2026-02-21T07:22:35.618Z",
  "trigger": "revision_requested",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\n本ドキュメントは、`kryota-dev/actions` リポジトリにおけるブランチ・タグのルールセット設計と関連するプロジェクト文書の整備について要件を定義する。\n\n### 背景\n\nPR #13（GITHUB_TOKEN 化）は PR #16 で revert された。これにより、リリースワークフロー（`my_release.yml`）は PAT（`APP_TOKEN`）使用に回帰した。\n\n前回の設計（spec: branch-ruleset）は `github-actions[bot]`（GITHUB_TOKEN）前提だったため、個人リポジトリにおけるバイパスアクター制約により PR 必須化・ステータスチェック必須化が実現できず、削除/force push 防止のみの弱い保護に留まっていた。\n\n**今回の前提（PAT 使用）における制約の解消:**\n\n- PAT はリポジトリオーナーとして認証される\n- 個人リポジトリでは、管理者（=オーナー）は GitHub の仕様により常にルールセットをバイパスできる\n- tagpr（リリース PR 作成）・bump_major_tag（メジャータグ force push）はいずれも PAT で動作するため、ルールセット制限を受けない\n- したがって、PR 必須化・ステータスチェック必須化・non_fast_forward 制限などの強力な保護が設定可能となった\n\n加えて、PR #16（revert）の副作用として `AGENTS.md`（GitHub Actions 向けガイド）と `CLAUDE.md`（Claude Code 向けガイド）が削除された。これらは PAT/GITHUB_TOKEN の決定とは無関係のプロジェクト文書であるため、再作成が必要である。\n\n### スコープの明確化\n\n- **対象**: ブランチ・タグルールセットの JSON ファイル（IaC）、ADR 作成、削除されたプロジェクト文書の再作成\n- **対象外**: ルールセットの GitHub Web UI への適用手順（手動作業）、既存ワークフローの変更、Renovate Bot 設定の変更\n\n## Alignment with Product Vision\n\n本リポジトリは、Reusable GitHub Actions Workflow を一元管理・公開することで複数リポジトリの CI/CD 設定の重複を排除することを目的とする。\n\nブランチ・タグ保護により以下を実現する:\n\n- 誤操作による main ブランチへの直接 push・削除を防止する\n- PR を介したコードレビュープロセスを強制する\n- CI ステータスチェックのパスを必須化し、品質ゲートを機能させる\n- リリース済みバージョンタグの改ざんを防止し、外部利用者への信頼性を維持する\n\n---\n\n## Requirements\n\n### Requirement 1: main ブランチの保護\n\n**User Story:** As a リポジトリ管理者, I want main ブランチへの直接 push と誤削除を防ぎ、PR を必須化したい, so that コードレビューを経た変更のみが main に取り込まれることを保証できる\n\n#### Acceptance Criteria\n\n1. WHEN main ブランチに対して削除操作が実行されたとき THEN ルールセット SHALL `deletion` ルールにより削除をブロックする\n2. WHEN main ブランチに対して non-fast-forward push（履歴書き換えを伴う push）が実行されたとき THEN ルールセット SHALL `non_fast_forward` ルールにより拒否する\n3. WHEN main ブランチに対して push が実行されたとき THEN ルールセット SHALL `required_linear_history` ルールによりマージコミットを禁止し、squash または rebase マージのみを許可する\n4. WHEN main ブランチへの変更が提案されたとき THEN ルールセット SHALL `pull_request` ルールにより PR の作成を必須とする（直接 push を禁止する）\n5. WHEN pull_request ルールが有効のとき THEN システム SHALL 最低 1 件の承認（`required_approving_review_count: 1`）を必須とする\n6. WHEN ステータスチェックが設定されているとき THEN ルールセット SHALL `required_status_checks` ルールにより指定チェックのパスを必須とする\n7. WHEN `required_status_checks` が有効のとき THEN システム SHALL 以下のステータスチェックをブロッキング対象とする:\n   - `lint`（`my_test.yml` の lint ジョブ）\n   - `analyze`（`my_codeql.yml` の analyze ジョブ）\n8. WHEN PAT（`APP_TOKEN`）でリポジトリオーナーが操作するとき THEN ルールセット SHALL 管理者バイパス（GitHub 個人リポジトリのオーナーはルールセットを常にバイパス可能）により、tagpr・bump_major_tag の操作を妨げない\n9. IF Renovate Bot が依存関係更新 PR を作成したとき THEN ルールセット SHALL `required_status_checks` の対象となり、CI が通過したものだけがマージ可能であることを保証する\n\n**備考（管理者バイパスの仕組み）:** GitHub の個人リポジトリでは、オーナーが管理者権限を持つため、ルールセットの bypass_actors 設定に明示的なアクターを追加しなくとも、オーナーによる操作（PAT 使用を含む）はルールセットの制限をバイパスする。これにより tagpr（リリース PR 作成・main への直接操作）および bump_major_tag（メジャータグ force push）は制限されない。\n\n---\n\n### Requirement 2: バージョンタグ（`v*.*.*`）の保護\n\n**User Story:** As a リリース管理者, I want 公開済みのバージョンタグ（vX.Y.Z 形式）の削除と変更を防ぎたい, so that 外部リポジトリが特定バージョンをピン留めして使用する際の信頼性を確保できる\n\n#### Acceptance Criteria\n\n1. WHEN `refs/tags/v*.*.*` パターンに合致するタグに対して削除操作が実行されたとき THEN ルールセット SHALL `deletion` ルールによりブロックする\n2. WHEN `refs/tags/v*.*.*` パターンに合致するタグに対して force push が実行されたとき THEN ルールセット SHALL `non_fast_forward` ルールによりブロックする\n3. IF tagpr がリリース PR マージ後に `vX.Y.Z` タグを付与するとき THEN ルールセット SHALL PAT（オーナー）バイパスにより tagpr の操作を妨げない\n4. WHEN ルールセットの条件を設定するとき THEN システム SHALL `refs/tags/v*.*.*` の `*` が `.`（ドット）を含む任意の文字列にマッチする fnmatch 仕様を考慮した上で、`v1.2.3` 形式のタグに正しく適用されることを確認する\n\n---\n\n### Requirement 3: メジャータグ（`v[0-9]*`）の保護\n\n**User Story:** As a リポジトリ管理者, I want メジャータグ（v1, v2 等）の誤削除を防ぎつつ、bump_major_tag による force push での更新を許可したい, so that 外部利用者は常に最新リリースをメジャータグで参照できる\n\n#### Acceptance Criteria\n\n1. WHEN `refs/tags/v[0-9]*` パターンに合致するタグに対して削除操作が実行されたとき THEN ルールセット SHALL `deletion` ルールによりブロックする\n2. WHEN `refs/tags/v[0-9]*` パターンに合致するタグに対して force push が実行されたとき THEN ルールセット SHALL `non_fast_forward` ルールを**適用しない**（bump_major_tag による `--force` での更新を許容する）\n3. WHEN bump_major_tag ジョブが PAT で `git push origin \"$MAJOR\" --force` を実行するとき THEN ルールセット SHALL PAT（オーナー）バイパスにより操作を妨げない\n4. WHEN ルールセットの条件を設定するとき THEN システム SHALL `refs/tags/v[0-9]*` パターンが `v10`、`v11` 等の 2 桁以上のメジャーバージョンにも正しくマッチすることを確認する\n\n---\n\n### Requirement 4: ルールセットの JSON 管理（IaC）\n\n**User Story:** As a リポジトリ管理者, I want ルールセット設定を JSON ファイルとしてバージョン管理したい, so that 設定変更の履歴を Git で追跡し、レビュープロセスを経て安全に適用できる\n\n#### Acceptance Criteria\n\n1. WHEN ルールセット設定ファイルを配置するとき THEN システム SHALL `.github/rulesets/` ディレクトリに JSON 形式で格納する\n2. WHEN main ブランチ保護ルールセットを定義するとき THEN システム SHALL `.github/rulesets/protect-main.json` として管理する\n3. WHEN バージョンタグ保護ルールセットを定義するとき THEN システム SHALL `.github/rulesets/protect-version-tags.json` として管理する\n4. WHEN メジャータグ保護ルールセットを定義するとき THEN システム SHALL `.github/rulesets/protect-major-tags.json` として管理する\n5. WHEN 各 JSON ファイルを作成するとき THEN システム SHALL GitHub API の Ruleset スキーマ（`name`, `target`, `enforcement`, `conditions`, `rules`, `bypass_actors`）に準拠した形式で定義する\n6. WHEN ルールセットを GitHub に適用するとき THEN 作業者 SHALL GitHub Web UI または GitHub CLI を用いて JSON をインポートする（手動手順）\n\n---\n\n### Requirement 5: ADR の作成\n\n**User Story:** As a リポジトリ管理者, I want PAT 前提のブランチルールセット設計の意思決定を ADR として記録したい, so that 将来の自分や貢献者が設計経緯（特に GITHUB_TOKEN からの回帰理由）を理解できる\n\n#### Acceptance Criteria\n\n1. WHEN ADR を作成するとき THEN システム SHALL `docs/adr/003-pat-branch-ruleset.md` として英語で記録する\n2. WHEN ADR 003 を作成するとき THEN ドキュメント SHALL 以下の内容を含む:\n   - PR #13（GITHUB_TOKEN 化）が revert（PR #16）された背景と理由\n   - PAT（`APP_TOKEN`）前提での設計再考の決定\n   - 個人リポジトリにおける管理者バイパスの仕組みとその活用\n   - PR 必須化・ステータスチェック必須化が実現可能になった理由\n3. WHEN ADR 003 を作成するとき THEN ドキュメント SHALL 既存 ADR（001）のフォーマット（Date / Status / Context / Decision / Consequences）に準拠する\n4. WHEN `docs/adr/README.md` を更新するとき THEN ドキュメント SHALL ADR 003 のエントリを追加する\n\n---\n\n### Requirement 6: AGENTS.md / CLAUDE.md の再作成\n\n**User Story:** As a リポジトリ管理者, I want PR #16（revert）で誤削除されたプロジェクト文書を再作成したい, so that AI エージェントおよび Claude Code がリポジトリの規約・運用ルールを正しく把握できる\n\n#### Acceptance Criteria\n\n1. WHEN `AGENTS.md` を再作成するとき THEN ファイル SHALL リポジトリルート（`/AGENTS.md`）に配置する\n2. WHEN `AGENTS.md` を作成するとき THEN ドキュメント SHALL GitHub Actions エージェント向けにリポジトリの目的・Workflow 命名規則・SHA ピン留めポリシー・権限最小化ルール・リリースフローを記載する\n3. WHEN `CLAUDE.md` を再作成するとき THEN ファイル SHALL リポジトリルート（`/CLAUDE.md`）に配置する\n4. WHEN `CLAUDE.md` を作成するとき THEN ドキュメント SHALL Claude Code 向けにプロジェクト概要・コマンド・アーキテクチャ・必須ルールを記載する\n5. WHEN `CLAUDE.md` を作成するとき THEN ドキュメント SHALL 現時点でリポジトリに存在しないが必要な情報（PAT 使用の経緯、ルールセット管理方針）を反映する\n\n---\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Single Responsibility Principle**: 各ルールセット JSON は保護対象（main / version-tags / major-tags）ごとに独立したファイルとして管理する\n- **Modular Design**: ルールセットは対象・目的ごとに分離し、一つのファイルに複数の保護対象を混在させない\n- **Clear Interfaces**: 各 JSON ファイルは GitHub API スキーマに準拠し、Web UI または CLI から直接インポート可能な形式とする\n\n### Security\n\n- ルールセットの `enforcement` は `active`（有効）に設定し、`disabled` や `evaluate` では運用しない\n- `bypass_actors` は空配列とする（個人リポジトリのオーナーバイパスは GitHub 仕様として機能するため、明示的な設定は不要）\n- PR 必須化による強制的なコードレビュープロセスを確立し、main への直接 push による意図しない変更を防止する\n- ステータスチェック（`lint`, `analyze`）の必須化により、セキュリティ検査（zizmor, ghalint, CodeQL）を通過しない変更のマージを防止する\n\n### Reliability\n\n- ルールセット JSON は GitHub API スキーマへの準拠を維持し、インポート時のエラーを防止する\n- tagpr・bump_major_tag の自動化フローがルールセットにより妨げられないことを設計レベルで保証する\n- Renovate Bot の依存関係更新 PR も CI ステータスチェックの適用対象となることを設計に反映する\n\n### Usability\n\n- ルールセット JSON はコメントなしで Git で管理し、変更意図は ADR と commit message で記録する\n- 各 JSON ファイル名は保護対象が一目でわかる命名とする（`protect-main.json`, `protect-version-tags.json`, `protect-major-tags.json`）\n- GitHub Web UI からのインポート手順は ADR または tasks.md の手動手順セクションに記載する\n\n---\n\n## Out of Scope\n\n以下は本スペックのスコープ外とする:\n\n- ルールセットを GitHub Web UI に適用する具体的な手動操作（tasks.md の手動手順として別途記載）\n- 既存 Workflow ファイル（`my_release.yml` 等）の変更\n- tagpr の設定（`.tagpr`）の変更\n- ADR 002 の廃止記録（PR #13 の GITHUB_TOKEN 化に関する ADR 002 は PR #16 の revert 前に削除済みのため、ADR 003 で経緯を説明するにとどめる）\n- 個人リポジトリ以外の組織リポジトリへの適用（bypass_actors の設定方法が異なるため、本スペックは個人リポジトリを前提とする）\n",
  "fileStats": {
    "size": 14336,
    "lines": 174,
    "lastModified": "2026-02-21T07:19:28.743Z"
  },
  "comments": []
}