{
  "id": "snapshot_1771669422470_nxv9708q3",
  "approvalId": "approval_1771669422468_1hbmmz8pb",
  "approvalTitle": "Tasks: composite-actions-creation",
  "version": 1,
  "timestamp": "2026-02-21T10:23:42.470Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document\n\n## Phase 1: pnpm-setup Composite Action の実装\n\n- [ ] 1. `.github/composite/pnpm-setup/action.yml` を作成する\n  - File: `.github/composite/pnpm-setup/action.yml`\n  - Node.js・pnpm のセットアップ、pnpm ストアキャッシュ、依存関係インストールを一括実行する Composite Action を実装する\n  - Purpose: 利用者リポジトリが `steps:` から1行で pnpm 環境を構築できるようにする\n  - _Leverage: `.github/composite/.gitkeep`（ディレクトリ構造の確認）、`composite-actions-support` spec の design.md（ディレクトリ規約）_\n  - _Requirements: 1, 5_\n  - _Prompt: Role: GitHub Actions エンジニア | Task: `.github/composite/pnpm-setup/action.yml` を以下の完全な YAML 内容で作成してください。ファイルが存在しない場合は新規作成し、`.github/composite/` ディレクトリに配置します。\n\n    ```yaml\n    name: Setup pnpm\n    description: Setup Node.js and pnpm, and install dependencies\n\n    runs:\n      using: 'composite'\n      steps:\n        - uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0\n          name: Install pnpm\n          with:\n            package_json_file: package.json\n            run_install: false\n\n        - name: Install Node.js\n          uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0\n          with:\n            node-version-file: .node-version\n            cache: 'pnpm'\n\n        - name: Get pnpm store directory\n          shell: bash\n          run: |\n            echo \"STORE_PATH=$(pnpm store path --silent)\" >> \"$GITHUB_ENV\"\n\n        - uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3\n          name: Setup pnpm cache\n          with:\n            path: ${{ env.STORE_PATH }}\n            key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}\n            restore-keys: |\n              ${{ runner.os }}-pnpm-store-\n\n        - name: Install dependencies\n          shell: bash\n          run: pnpm install\n    ```\n\n    注意事項:\n    - `uses:` は全て full commit SHA（40文字）でピン留め済み（変更しないこと）\n    - `run` ステップには `shell: bash` を必ず明記すること\n    - `inputs:` フィールドはなし（入力なし設計）\n    - ファイル名は `action.yml`（`action.yaml` は不可）_\n\n---\n\n## Phase 2: playwright-setup Composite Action の実装\n\n- [ ] 2. `.github/composite/playwright-setup/action.yml` を作成する\n  - File: `.github/composite/playwright-setup/action.yml`\n  - Playwright ブラウザをキャッシュ付きでインストールする Composite Action を実装する\n  - Purpose: 利用者リポジトリが CI の Playwright ブラウザインストール時間を短縮できるようにする\n  - _Leverage: `composite-actions-support` spec の design.md（セキュリティポリシー）_\n  - _Requirements: 2, 5_\n  - _Prompt: Role: GitHub Actions エンジニア | Task: `.github/composite/playwright-setup/action.yml` を以下の完全な YAML 内容で作成してください。`pnpm-setup` Action（または同等のセットアップ）が前提条件です。\n\n    ```yaml\n    name: Setup Playwright\n    description: Setup Playwright browsers with caching\n\n    runs:\n      using: 'composite'\n      steps:\n        - name: Get Playwright version\n          id: playwright-version\n          shell: bash\n          run: |\n            PLAYWRIGHT_VERSION=$(pnpm exec playwright --version | sed 's/Version //')\n            echo \"version=$PLAYWRIGHT_VERSION\" >> \"$GITHUB_OUTPUT\"\n\n        - name: Cache Playwright browsers\n          id: cache-playwright\n          uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3\n          with:\n            path: ~/.cache/ms-playwright\n            key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}\n\n        - name: Install Playwright browsers\n          if: steps.cache-playwright.outputs.cache-hit != 'true'\n          shell: bash\n          run: pnpm exec playwright install --with-deps\n    ```\n\n    注意事項:\n    - `uses:` は full commit SHA（40文字）でピン留め済み（変更しないこと）\n    - `run` ステップには `shell: bash` を必ず明記すること\n    - `if: steps.cache-playwright.outputs.cache-hit != 'true'` によりキャッシュヒット時はインストールをスキップする（明示的な条件指定）\n    - `inputs:` フィールドはなし（入力なし設計）_\n\n---\n\n## Phase 3: slack-notify-success Composite Action の実装\n\n- [ ] 3. `.github/composite/slack-notify-success/action.yml` を作成する\n  - File: `.github/composite/slack-notify-success/action.yml`\n  - ワークフロー成功時に Slack の `chat.postMessage` API へ通知する Composite Action を実装する\n  - Purpose: 利用者リポジトリが成功通知を標準フォーマットで Slack に投稿できるようにする\n  - _Leverage: `composite-actions-support` spec の design.md（セキュリティポリシー：env 経由の入力値渡し）_\n  - _Requirements: 3, 5_\n  - _Prompt: Role: GitHub Actions エンジニア | Task: `.github/composite/slack-notify-success/action.yml` を以下の完全な YAML 内容で作成してください。\n\n    ```yaml\n    name: Post Message to Slack - Success\n    description: Post a message to Slack when the workflow succeeds\n\n    inputs:\n      channel-id:\n        description: Slack Channel ID\n        required: true\n      bot-oauth-token:\n        description: Slack Bot OAuth Token\n        required: true\n      color:\n        description: Color of the message\n        required: false\n        default: good\n      mention-user:\n        description: Mention user\n        required: false\n        default: ''\n      title:\n        description: Message title\n        required: false\n        default: 'workflow execution completed'\n      message:\n        description: Message body\n        required: false\n        default: 'Execution log: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'\n      thread-ts:\n        description: Thread timestamp for reply\n        required: false\n        default: 'null'\n      reply-broadcast:\n        description: Whether to broadcast the reply to the channel\n        required: false\n        default: 'false'\n\n    runs:\n      using: 'composite'\n      steps:\n        - id: post-message-success\n          shell: bash\n          env:\n            SLACK_CHANNEL_ID: ${{ inputs.channel-id }}\n            SLACK_BOT_OAUTH_TOKEN: ${{ inputs.bot-oauth-token }}\n            SLACK_COLOR: ${{ inputs.color }}\n            SLACK_MENTION_USER: ${{ inputs.mention-user }}\n            SLACK_TITLE_TEXT: ${{ inputs.title }}\n            SLACK_MESSAGE: ${{ inputs.message }}\n            SLACK_THREAD_TS: ${{ inputs.thread-ts }}\n            SLACK_REPLY_BROADCAST: ${{ inputs.reply-broadcast }}\n            RUNNER_DEBUG: ${{ runner.debug }}\n          run: |\n            if [ \"${RUNNER_DEBUG}\" == \"1\" ]; then\n              set -x\n            fi\n            if [ -n \"${SLACK_MENTION_USER}\" ]; then\n              SLACK_TITLE=\"*SUCCESS - ${SLACK_MENTION_USER} ${SLACK_TITLE_TEXT}*\"\n            else\n              SLACK_TITLE=\"*SUCCESS - ${SLACK_TITLE_TEXT}*\"\n            fi\n            REPO_NAME=\"${GITHUB_REPOSITORY#${GITHUB_REPOSITORY_OWNER}/}\"\n            REPO_URL=\"${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}\"\n            SLACK_DATA=$(jq -n \\\n              --arg channel \"${SLACK_CHANNEL_ID}\" \\\n              --arg color \"${SLACK_COLOR}\" \\\n              --arg title \"${SLACK_TITLE}\" \\\n              --arg author_name \"${REPO_NAME}\" \\\n              --arg author_link \"${REPO_URL}\" \\\n              --arg text \"${SLACK_MESSAGE}\" \\\n              --arg thread_ts \"${SLACK_THREAD_TS}\" \\\n              --argjson reply_broadcast \"${SLACK_REPLY_BROADCAST}\" \\\n              'def base:\n                {\n                  channel: $channel,\n                  attachments: [{\n                    fallback: $title,\n                    pretext: $title,\n                    color: $color,\n                    author_name: $author_name,\n                    author_link: $author_link,\n                    text: $text\n                  }]\n                };\n              if $thread_ts != \"null\" then\n                base + {thread_ts: $thread_ts, reply_broadcast: $reply_broadcast}\n              else\n                base\n              end')\n            RESPONSE=$(curl --max-time 30 -sS -X POST \\\n              -H \"Content-Type: application/json\" \\\n              -H \"Authorization: Bearer ${SLACK_BOT_OAUTH_TOKEN}\" \\\n              -d \"${SLACK_DATA}\" \\\n              \"https://slack.com/api/chat.postMessage\") \\\n              || { echo \"::error::Failed to post message to Slack (network error)\"; exit 1; }\n            if echo \"${RESPONSE}\" | grep -q '\"ok\":false'; then\n              echo \"::error::Slack API returned error: ${RESPONSE}\"\n              exit 1\n            fi\n    ```\n\n    注意事項:\n    - `${{ inputs.xxx }}` を `run:` に直接埋め込まず、全て `env:` 経由で渡すこと（テンプレートインジェクション対策）\n    - `runner.debug` も `RUNNER_DEBUG` として `env:` 経由で渡すこと\n    - `jq` で JSON を構築すること（`ubuntu-latest` に標準搭載）\n    - Slack API は HTTP 200 でも `\"ok\":false` を返す場合があるため、`grep '\"ok\":false'` でレスポンスを検証すること\n    - `curl --max-time 30 -sS` でタイムアウト設定とレスポンス格納を行うこと\n    - `uses:` フィールドはなし（`curl` と `jq` のみ使用）_\n\n---\n\n## Phase 4: slack-notify-failure Composite Action の実装\n\n- [ ] 4. `.github/composite/slack-notify-failure/action.yml` を作成する\n  - File: `.github/composite/slack-notify-failure/action.yml`\n  - ワークフロー失敗時に Slack の Incoming Webhook URL へ通知する Composite Action を実装する\n  - Purpose: 利用者リポジトリが失敗通知を標準フォーマットで Slack に投稿できるようにする\n  - _Leverage: `composite-actions-support` spec の design.md（セキュリティポリシー：env 経由の入力値渡し）_\n  - _Requirements: 4, 5_\n  - _Prompt: Role: GitHub Actions エンジニア | Task: `.github/composite/slack-notify-failure/action.yml` を以下の完全な YAML 内容で作成してください。`slack-notify-success` と異なり、Incoming Webhook URL を使用するため `channel-id` / `bot-oauth-token` / `thread-ts` / `reply-broadcast` は不要です。\n\n    ```yaml\n    name: Post Message to Slack - Failure\n    description: Post a message to Slack when the workflow fails\n\n    inputs:\n      webhook-url:\n        description: Slack Incoming Webhook URL\n        required: true\n      color:\n        description: Color of the message\n        required: false\n        default: danger\n      mention-user:\n        description: Mention user\n        required: false\n        default: ''\n      title:\n        description: Message title\n        required: false\n        default: 'workflow failed'\n      message:\n        description: Message body\n        required: false\n        default: 'Execution log: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'\n\n    runs:\n      using: 'composite'\n      steps:\n        - id: post-message-failure\n          shell: bash\n          env:\n            SLACK_WEBHOOK_URL: ${{ inputs.webhook-url }}\n            SLACK_COLOR: ${{ inputs.color }}\n            SLACK_MENTION_USER: ${{ inputs.mention-user }}\n            SLACK_TITLE_TEXT: ${{ inputs.title }}\n            SLACK_MESSAGE: ${{ inputs.message }}\n            RUNNER_DEBUG: ${{ runner.debug }}\n          run: |\n            if [ \"${RUNNER_DEBUG}\" == \"1\" ]; then\n              set -x\n            fi\n            if [ -n \"${SLACK_MENTION_USER}\" ]; then\n              SLACK_TITLE=\"*FAILURE - ${SLACK_MENTION_USER} ${SLACK_TITLE_TEXT}*\"\n            else\n              SLACK_TITLE=\"*FAILURE - ${SLACK_TITLE_TEXT}*\"\n            fi\n            REPO_NAME=\"${GITHUB_REPOSITORY#${GITHUB_REPOSITORY_OWNER}/}\"\n            REPO_URL=\"${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}\"\n            SLACK_DATA=$(jq -n \\\n              --arg color \"${SLACK_COLOR}\" \\\n              --arg title \"${SLACK_TITLE}\" \\\n              --arg author_name \"${REPO_NAME}\" \\\n              --arg author_link \"${REPO_URL}\" \\\n              --arg text \"${SLACK_MESSAGE}\" \\\n              '{\n                attachments: [{\n                  fallback: $title,\n                  pretext: $title,\n                  color: $color,\n                  author_name: $author_name,\n                  author_link: $author_link,\n                  text: $text\n                }]\n              }')\n            curl --max-time 30 --fail -sS -X POST \\\n              -H \"Content-Type: application/json\" \\\n              -d \"${SLACK_DATA}\" \\\n              \"${SLACK_WEBHOOK_URL}\" \\\n              || { echo \"::error::Failed to post message to Slack\"; exit 1; }\n    ```\n\n    注意事項:\n    - `${{ inputs.xxx }}` を `run:` に直接埋め込まず、全て `env:` 経由で渡すこと（テンプレートインジェクション対策）\n    - `runner.debug` も `RUNNER_DEBUG` として `env:` 経由で渡すこと\n    - `jq` で JSON を構築すること（`ubuntu-latest` に標準搭載）\n    - Incoming Webhook は HTTP ステータスでエラーを返すため `--fail` オプションで十分（`\"ok\":false` チェック不要）\n    - `slack-notify-success` と異なり `channel` フィールドは JSON に含めない（Webhook URL にチャンネルが埋め込まれているため）\n    - `uses:` フィールドはなし（`curl` と `jq` のみ使用）_\n\n---\n\n## Phase 5: .gitkeep の削除\n\n- [ ] 5. `.github/composite/.gitkeep` を削除する\n  - File: `.github/composite/.gitkeep`（削除）\n  - Purpose: 実際の Composite Actions が追加されたため、ディレクトリを Git 管理するための `.gitkeep` は不要になる\n  - _Leverage: なし_\n  - _Requirements: 1, 2, 3, 4（ディレクトリに実ファイルが追加されたため）_\n  - _Prompt: Role: GitHub Actions エンジニア | Task: `.github/composite/.gitkeep` ファイルを削除してください。Phase 1〜4 で実際の `action.yml` ファイルが配置されたため、このファイルは不要です。`git rm .github/composite/.gitkeep` または通常のファイル削除で対応してください。削除後に `.github/composite/` ディレクトリが以下の構造になっていることを確認してください:\n\n    ```\n    .github/composite/\n      pnpm-setup/\n        action.yml\n      playwright-setup/\n        action.yml\n      slack-notify-success/\n        action.yml\n      slack-notify-failure/\n        action.yml\n    ```\n\n    注意事項:\n    - `.gitkeep` 以外のファイルは削除しないこと\n    - `.github/composite/` ディレクトリ自体は残すこと_\n\n---\n\n## Phase 6: README.md の Composite Actions セクション更新\n\n- [ ] 6. `README.md` の `### Composite Actions` セクションを更新する\n  - File: `README.md`\n  - `### Composite Actions` セクションの `Coming soon.` を各 Action の使用方法・入力パラメータ一覧に置き換える\n  - Purpose: 利用者が README から各 Composite Action の使い方をすぐに把握できるようにする\n  - _Leverage: 現行の `README.md`（既存の `## Usage` セクション・`### Composite Actions` セクションの構造を維持する）_\n  - _Requirements: 6_\n  - _Prompt: Role: テクニカルライター | Task: `README.md` の `### Composite Actions` セクションを以下の内容に更新してください。現在は `Coming soon.` のみが記載されているため、各 Action の詳細に置き換えます。\n\n    **現在の `### Composite Actions` セクション（変更前）:**\n    ```markdown\n    ### Composite Actions\n\n    Coming soon.\n    ```\n\n    **更新後の `### Composite Actions` セクション（変更後）:**\n    ```markdown\n    ### Composite Actions\n\n    #### pnpm-setup\n\n    Node.js と pnpm のセットアップ、pnpm ストアキャッシュ、依存関係インストールを一括実行します。\n\n    **前提条件:** リポジトリルートに `.node-version`・`package.json`・`pnpm-lock.yaml` が存在すること\n\n    ```yaml\n    steps:\n      - uses: kryota-dev/actions/.github/composite/pnpm-setup@v1\n    ```\n\n    ---\n\n    #### playwright-setup\n\n    Playwright ブラウザをキャッシュ付きでインストールします。キャッシュヒット時はダウンロードをスキップします。\n\n    **前提条件:** `pnpm-setup` Action（または同等のセットアップ）が先に完了していること\n\n    ```yaml\n    steps:\n      - uses: kryota-dev/actions/.github/composite/pnpm-setup@v1\n      - uses: kryota-dev/actions/.github/composite/playwright-setup@v1\n    ```\n\n    ---\n\n    #### slack-notify-success\n\n    ワークフロー成功時に Slack へ通知します。Slack Bot OAuth Token と `chat.postMessage` API を使用します。\n\n    | 入力名 | 必須 | デフォルト値 | 説明 |\n    |---|---|---|---|\n    | `channel-id` | 必須 | - | Slack チャンネル ID |\n    | `bot-oauth-token` | 必須 | - | Slack Bot OAuth Token |\n    | `color` | 任意 | `good` | メッセージのカラーバー色 |\n    | `mention-user` | 任意 | `''` | メンション対象ユーザー |\n    | `title` | 任意 | `workflow execution completed` | メッセージタイトル |\n    | `message` | 任意 | 実行ログ URL | メッセージ本文 |\n    | `thread-ts` | 任意 | `'null'` | スレッド返信先 timestamp |\n    | `reply-broadcast` | 任意 | `'false'` | スレッド返信をチャンネルにもブロードキャストするか |\n\n    ```yaml\n    steps:\n      - uses: kryota-dev/actions/.github/composite/slack-notify-success@v1\n        with:\n          channel-id: ${{ vars.SLACK_CHANNEL_ID }}\n          bot-oauth-token: ${{ secrets.SLACK_BOT_OAUTH_TOKEN }}\n    ```\n\n    ---\n\n    #### slack-notify-failure\n\n    ワークフロー失敗時に Slack へ通知します。Slack Incoming Webhook URL を使用します（`slack-notify-success` と異なり、チャンネル指定不要）。\n\n    | 入力名 | 必須 | デフォルト値 | 説明 |\n    |---|---|---|---|\n    | `webhook-url` | 必須 | - | Slack Incoming Webhook URL |\n    | `color` | 任意 | `danger` | メッセージのカラーバー色 |\n    | `mention-user` | 任意 | `''` | メンション対象ユーザー |\n    | `title` | 任意 | `workflow failed` | メッセージタイトル |\n    | `message` | 任意 | 実行ログ URL | メッセージ本文 |\n\n    ```yaml\n    steps:\n      - uses: kryota-dev/actions/.github/composite/slack-notify-failure@v1\n        with:\n          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}\n    ```\n    ```\n\n    注意事項:\n    - `## Usage` セクションや `### Reusable Workflows` セクション等、他のセクションは変更しないこと\n    - `### Internal CI Workflows` セクションより前に `### Composite Actions` セクションが位置していることを確認すること\n    - YAML コードブロック内のバッククォートが正しくレンダリングされることを確認すること_\n",
  "fileStats": {
    "size": 19377,
    "lines": 438,
    "lastModified": "2026-02-21T10:23:12.661Z"
  },
  "comments": []
}