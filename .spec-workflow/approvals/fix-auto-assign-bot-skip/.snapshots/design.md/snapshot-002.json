{
  "id": "snapshot_1771869502151_urdpdoh0s",
  "approvalId": "approval_1771869372299_ri323f1vl",
  "approvalTitle": "Design: Bot PR アサインスキップ + 代替アサイン先指定",
  "version": 2,
  "timestamp": "2026-02-23T17:58:22.151Z",
  "trigger": "revision_requested",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\n`auto-assign-pr.yml` Reusable Workflow を修正し、Bot ユーザーが作成した PR で失敗しないようにする。Bot PR の場合は呼び出し元が指定した代替アサイン先にアサインし、指定がなければスキップする。通常ユーザーの PR では従来通り PR 作成者をアサインする。\n\n## Steering Document Alignment\n\n### Technical Standards\n- GitHub Actions YAML のみで実装（TypeScript/JavaScript なし）\n- SHA ピン留めルール遵守（外部 Action 使用なし、`gh` CLI のみなので該当なし）\n- actionlint / ghalint / zizmor の CI チェックを通過すること\n\n### Project Structure\n- `auto-assign-pr.yml`: Reusable Workflow（`.github/workflows/` に配置）\n- `my-setup-pr.yml`: 内部 CI 薄いラッパー（`.github/workflows/` に配置）\n- `auto-assign-pr.md`: ワークフロードキュメント（`.github/workflows/docs/` に配置）\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **`auto-assign-pr.yml`**: 既存の Reusable Workflow。`workflow_call` の inputs に `bot-assignees` パラメータを追加し、Bot 判定ロジックとアサイン分岐を追加する\n- **`my-setup-pr.yml`**: 既存の薄いラッパー。`with` で `bot-assignees` を渡すよう修正する\n\n### Integration Points\n- **`workflow_call` インターフェース**: `inputs.bot-assignees`（string, optional, default: ''）を追加。既存の呼び出し元は変更不要（後方互換）\n\n## Architecture\n\nBot 判定は `github.actor` の末尾が `[bot]` であるかどうかで行う。\n\n> **重要**: `github.actor_type` は GitHub Actions の公式コンテキストに存在しないため使用しない。`github.actor` の文字列パターンマッチで Bot を判定する。\n\n```mermaid\nflowchart TD\n    A[PR opened] --> B[my-setup-pr.yml triggers]\n    B --> C[auto-assign-pr.yml called]\n    C --> D{github.actor ends with '[bot]'?}\n    D -->|Yes - Bot| E{bot-assignees specified?}\n    E -->|Yes| F[Assign bot-assignees to PR]\n    E -->|No| G[Skip assignment - log message]\n    D -->|No - Human| H[Assign github.actor to PR]\n    F --> I[Done - Success]\n    G --> I\n    H --> I\n```\n\n### Modular Design Principles\n- **Single File Responsibility**: Bot 判定とアサインロジックは `auto-assign-pr.yml` 内で完結\n- **Component Isolation**: `my-setup-pr.yml` は `with` パラメータの追加のみ。ロジックは Reusable Workflow に委譲\n- **Clear Interfaces**: `workflow_call.inputs.bot-assignees` が唯一のインターフェース追加\n\n## Components and Interfaces\n\n### Component 1: `auto-assign-pr.yml`（Reusable Workflow）\n\n- **Purpose:** PR 作成者の自動アサイン。Bot PR の場合は代替アサインまたはスキップ\n- **Interfaces:**\n  - `workflow_call.inputs.bot-assignees`（string, required: false, default: ''）: Bot PR 時のアサイン先（カンマ区切り）\n- **Dependencies:** `gh` CLI（GitHub-hosted runner に標準搭載）\n- **Reuses:** 既存の `gh pr edit --add-assignee` パターン\n\n#### 実装詳細\n\n```yaml\non:\n  workflow_call:\n    inputs:\n      bot-assignees:\n        description: 'Comma-separated list of users/teams to assign for bot PRs (empty = skip)'\n        required: false\n        type: string\n        default: ''\n\njobs:\n  add_assignee:\n    runs-on: ubuntu-latest\n    timeout-minutes: 5\n    permissions:\n      pull-requests: write\n    steps:\n      - name: Check if actor is a bot\n        id: check-bot\n        run: |\n          if [[ \"$ACTOR\" == *\"[bot]\" ]]; then\n            echo \"is_bot=true\" >> \"$GITHUB_OUTPUT\"\n            echo \"::notice::Actor '$ACTOR' is a bot\"\n          else\n            echo \"is_bot=false\" >> \"$GITHUB_OUTPUT\"\n          fi\n        env:\n          ACTOR: ${{ github.actor }}\n\n      - name: Assign PR creator (human)\n        if: steps.check-bot.outputs.is_bot == 'false'\n        run: gh pr edit \"$PR_URL\" --add-assignee \"$ACTOR\"\n        env:\n          GH_TOKEN: ${{ github.token }}\n          PR_URL: ${{ github.event.pull_request.html_url }}\n          ACTOR: ${{ github.actor }}\n\n      - name: Assign bot-assignees (bot with assignees specified)\n        if: steps.check-bot.outputs.is_bot == 'true' && inputs.bot-assignees != ''\n        run: |\n          IFS=',' read -ra ASSIGNEES <<< \"$BOT_ASSIGNEES\"\n          for assignee in \"${ASSIGNEES[@]}\"; do\n            trimmed=$(echo \"$assignee\" | xargs)\n            echo \"Assigning '$trimmed' to PR\"\n            gh pr edit \"$PR_URL\" --add-assignee \"$trimmed\"\n          done\n        env:\n          GH_TOKEN: ${{ github.token }}\n          PR_URL: ${{ github.event.pull_request.html_url }}\n          BOT_ASSIGNEES: ${{ inputs.bot-assignees }}\n\n      - name: Skip assignment (bot without assignees)\n        if: steps.check-bot.outputs.is_bot == 'true' && inputs.bot-assignees == ''\n        run: echo \"::notice::Skipping assignment for bot actor '$ACTOR' (no bot-assignees specified)\"\n        env:\n          ACTOR: ${{ github.actor }}\n```\n\n### Component 2: `my-setup-pr.yml`（内部 CI ラッパー）\n\n- **Purpose:** `auto-assign-pr.yml` を呼び出す薄いラッパー。`bot-assignees` に `kryota-dev` を指定\n- **Interfaces:** なし（内部 CI）\n- **Dependencies:** `auto-assign-pr.yml`\n\n#### 実装詳細\n\n```yaml\njobs:\n  auto-assign:\n    permissions:\n      pull-requests: write\n    uses: ./.github/workflows/auto-assign-pr.yml\n    with:\n      bot-assignees: 'kryota-dev'\n```\n\n### Component 3: `auto-assign-pr.md`（ドキュメント更新）\n\n- **Purpose:** `bot-assignees` パラメータの追加をドキュメントに反映\n- **Interfaces:** N/A\n- **Dependencies:** N/A\n\n## Data Models\n\nN/A（YAML ワークフローのみ。データベースやモデルは不要）\n\n## Error Handling\n\n### Error Scenarios\n1. **Bot PR で `bot-assignees` に無効なユーザー名が指定された場合**\n   - **Handling:** `gh pr edit --add-assignee` がエラーを返すが、他のアサイン先の処理は継続しない（ステップが失敗しワークフローは失敗終了）\n   - **User Impact:** ワークフロー失敗として表示される。正しいユーザー名を設定する必要がある\n   - **備考:** 呼び出し元が正しいユーザー名を指定する責任を持つ。無効な名前のバリデーションはスコープ外\n\n2. **`github.actor` の判定ミス（Bot なのに `[bot]` で終わらないケース）**\n   - **Handling:** 通常ユーザーとして扱い、`gh pr edit --add-assignee` が実行される。アサインできない場合はエラーとなる\n   - **User Impact:** ワークフロー失敗。ただし、GitHub の主要 Bot（dependabot, renovate, github-actions 等）はすべて `[bot]` サフィックスを持つため、実質的なリスクは低い\n\n## Testing Strategy\n\n### Unit Testing\n- GitHub Actions YAML にはユニットテストの仕組みがないため、CI パイプラインでの動作確認が主な検証手段\n\n### Integration Testing\n- **通常ユーザー PR**: 手動で PR を作成し、アサインが正常に動作することを確認\n- **Bot PR**: Renovate Bot が PR を作成した際に、`kryota-dev` がアサインされることを確認\n\n### Lint / Static Analysis\n- `actionlint`: ワークフロー構文チェック\n- `ghalint`: セキュリティポリシー検証\n- `zizmor`: テンプレートインジェクション等の静的セキュリティ分析\n",
  "fileStats": {
    "size": 7486,
    "lines": 176,
    "lastModified": "2026-02-23T17:56:06.851Z"
  },
  "comments": []
}