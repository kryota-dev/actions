{
  "id": "snapshot_1771665590910_x60ru13lw",
  "approvalId": "approval_1771665590907_wgma5utk5",
  "approvalTitle": "Design: composite-actions-support",
  "version": 1,
  "timestamp": "2026-02-21T09:19:50.910Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\n本ドキュメントは、`kryota-dev/actions` リポジトリに Composite Actions サポートを追加するための技術設計を定義する。\n\n変更の全体像は以下の4点に集約される:\n\n1. **ディレクトリ構造の追加**: `.github/composite/{action-name}/action.yml` の格納場所を新設\n2. **ls-lint 設定の拡張**: `.github/composite/` ディレクトリの kebab-case 命名規則を追加\n3. **CI パイプラインの拡張**: `my_test.yml` に `ghalint run-action` ステップを追加\n4. **README の更新**: Composite Actions の利用方法を追記\n\n既存の Reusable Workflows、リリース管理（tagpr）、zizmor、Renovate Bot は**設定変更不要**で Composite Actions に対応できる。\n\n## Steering Document Alignment\n\n### 技術基準（既存コーディング規約）\n\n- `uses:` は full commit SHA（40文字）でピン留め（`ghalint` / `zizmor` で CI 検証）\n- Renovate Bot により SHA を自動更新\n- `permissions: {}` をトップレベルに設定し、各 job で最小権限のみ付与\n- `timeout-minutes` を全 job に設定\n\n### プロジェクト構造規約\n\n- `.github/workflows/` 配下の `.yml`: snake_case（ls-lint で強制）\n- 内部 CI ワークフロー: `my_` プレフィックス\n- Composite Actions は `.github/composite/` 配下に分離（actionlint の誤検知を回避）\n\n## Code Reuse Analysis\n\n### 既存コンポーネントの活用\n\n| コンポーネント | 活用方法 |\n|---|---|\n| `aqua.yaml` の `ghalint@v1.5.5` | `ghalint run-action` コマンドはすでにインストール済みの ghalint で実行可能。新規インストール不要 |\n| `my_test.yml` の aqua-installer ステップ | 既存の aqua セットアップステップの後に `ghalint run-action` ステップを追加するだけでよい |\n| `renovate.json5` の `helpers:pinGitHubActionDigests` | Renovate の `github-actions` マネージャーはデフォルトで `/(^|/)action\\.ya?ml$/` パターンに一致するファイルをスキャンするため、`.github/composite/` 配下の `action.yml` も**追加設定不要**で自動更新対象となる |\n| `uvx zizmor --format=github .` | リポジトリルートを指定しているため、`.github/composite/` 配下の `action.yml` も**追加設定不要**で自動スキャン対象となる（zizmor v1.0.0 以降） |\n| `.tagpr` / `my_release.yml` | タグはリポジトリ全体に適用されるため、`.github/composite/` 配下の Composite Actions も同一タグで参照可能。**設定変更不要** |\n\n### 変更が必要なファイル\n\n| ファイル | 変更種別 | 変更内容 |\n|---|---|---|\n| `.ls-lint.yml` | 修正 | `.github/composite/` の kebab-case ルール追加 |\n| `.github/workflows/my_test.yml` | 修正 | `ghalint run-action` ステップ追加 |\n| `README.md` | 修正 | Composite Actions セクション追加 |\n| `.github/composite/` | 新規作成 | ディレクトリ（初期は空、またはサンプル action.yml を含む） |\n\n## Architecture\n\n### ディレクトリ構造（To-Be）\n\n```\n.github/\n  composite/                    # Composite Actions 格納ディレクトリ（新規）\n    {action-name}/              # 各 Action のサブディレクトリ（kebab-case）\n      action.yml                # Composite Action 定義ファイル\n  workflows/\n    my_test.yml                 # CI: ghalint run-action ステップ追加\n    my_setup_pr.yml             # 変更なし\n    my_release.yml              # 変更なし\n    my_codeql.yml               # 変更なし\n  rulesets/                     # 変更なし\n  CODEOWNERS                    # 変更なし\n  release.yml                   # 変更なし\n.ls-lint.yml                    # 変更: .github/composite/ ルール追加\nREADME.md                       # 変更: Composite Actions セクション追加\naqua.yaml                       # 変更なし（ghalint は run-action も使用可能）\nrenovate.json5                  # 変更なし\n```\n\n### ツールと Composite Actions の対応関係\n\n```mermaid\ngraph TD\n    subgraph CI[\"CI パイプライン (my_test.yml)\"]\n        AL[\"reviewdog/action-actionlint<br/>対象: .github/workflows/*.yml のみ<br/>（.github/composite/ は対象外）\"]\n        LS[\"ls-lint/action<br/>対象: .github/workflows/ → snake_case<br/>.github/composite/ → kebab-case (新規追加)\"]\n        GR[\"ghalint run<br/>対象: .github/workflows/*.yml\"]\n        GA[\"ghalint run-action (新規追加)<br/>対象: action.yml (3階層以内)\"]\n        ZI[\"zizmor<br/>対象: .github/workflows/ + .github/composite/ (自動発見)\"]\n    end\n\n    subgraph FILES[\".github/composite/{name}/action.yml\"]\n        CA[\"Composite Action 定義\"]\n    end\n\n    subgraph TOOLS[\"外部ツール\"]\n        RV[\"Renovate Bot<br/>github-actions manager<br/>action.yml を自動発見・更新\"]\n        TP[\"tagpr<br/>リポジトリ全体にタグ付与\"]\n    end\n\n    AL -->|\"スキャン対象外 (誤検知回避)\"| FILES\n    LS -->|\"命名規則検証\"| FILES\n    GR -->|\"スキャン対象外\"| FILES\n    GA -->|\"SHA ピン留め検証\"| FILES\n    ZI -->|\"セキュリティ静的解析\"| FILES\n    RV -->|\"uses: SHA 自動更新\"| FILES\n    TP -->|\"バージョンタグ適用\"| FILES\n```\n\n### actionlint が `.github/composite/` を誤検知しない仕組み\n\n`reviewdog/action-actionlint` Action は内部的に actionlint を `.github/workflows/` ディレクトリに対してのみ実行する。`.github/composite/` は `workflows/` ディレクトリとは別パスに存在するため、actionlint のスキャン対象に含まれない。`.github/composite/` へ分離配置することで、追加設定なしに誤検知を回避できる。\n\n### ghalint run vs run-action の使い分け\n\n| コマンド | 対象 | 用途 |\n|---|---|---|\n| `ghalint run` | `.github/workflows/*.yml` | Reusable Workflows / 内部 CI の検証（既存） |\n| `ghalint run-action` | `^([^/]+/){0,3}action\\.ya?ml$` にマッチするファイル | Composite Actions の `action.yml` 検証（新規追加） |\n\n`.github/composite/{action-name}/action.yml` は `.github/composite/action-name/action.yml` と展開され、3階層（`.github` / `composite` / `action-name`）となるため、`ghalint run-action` の正規表現パターン `^([^/]+/){0,3}action\\.ya?ml$` に合致する。\n\n## Components and Interfaces\n\n### Component 1: `.github/composite/` ディレクトリ構造\n\n- **Purpose:** Composite Actions を格納する。actionlint の誤検知を避けるため `workflows/` と分離する\n- **命名規則:** サブディレクトリ名は kebab-case（ls-lint で強制）\n- **action.yml の必須フィールド:**\n  ```yaml\n  name: # Action の表示名\n  description: # Action の説明（GitHub UI での視認性）\n  inputs:      # 入力パラメータ（任意だが明示的に定義を推奨）\n  outputs:     # 出力パラメータ（任意だが明示的に定義を推奨）\n  runs:\n    using: \"composite\"\n    steps:\n      - shell: bash  # run ステップには必ず shell を明記\n  ```\n- **外部参照形式:** `kryota-dev/actions/.github/composite/{action-name}@{tag-or-sha}`\n\n### Component 2: `.ls-lint.yml` の変更\n\n- **Purpose:** `.github/composite/` 配下のディレクトリ・ファイル命名規則を CI で強制する\n- **現在の設定:**\n  ```yaml\n  ls-lint:\n    .github/workflows:\n      .yml: snake_case\n  ```\n- **変更後の設定:**\n  ```yaml\n  ls-lint:\n    .github/workflows:\n      .yml: snake_case\n    .github/composite:\n      .dir: kebab-case\n      .yml: regex:action\n  ```\n  - `.dir: kebab-case`: サブディレクトリ名（Action 名）を kebab-case に強制\n  - `.yml: regex:action`: `action.yml` のみを許可（`action.yaml` は GitHub の仕様上 `action.yml` が推奨）\n\n  **注意:** ls-lint v2.x では `ls-lint:` キーの下に設定を記述する（現行設定に合わせる）\n\n### Component 3: `my_test.yml` への `ghalint run-action` ステップ追加\n\n- **Purpose:** Composite Actions の `action.yml` に対して ghalint によるセキュリティポリシー検証を実施する\n- **変更箇所:** 既存の `Run ghalint` ステップの直後に `Run ghalint run-action` ステップを追加\n- **変更後の関連ステップ:**\n  ```yaml\n  - name: Run ghalint\n    run: ghalint run\n    shell: bash\n\n  - name: Run ghalint run-action\n    run: ghalint run-action\n    shell: bash\n  ```\n  - aqua によって ghalint はすでにインストール・PATH 設定済みのため、追加のセットアップステップは不要\n  - `ghalint run-action` はカレントディレクトリ配下の `action.yml` を再帰的に検索して検証する\n\n### Component 4: `README.md` の変更\n\n- **Purpose:** Composite Actions の利用者が参照方法をすぐに把握できるドキュメントを提供する\n- **変更箇所:** `## Available Workflows` セクションを以下の構造に変更する\n\n  **現在の構造:**\n  ```markdown\n  ## Available Workflows\n\n  ### Reusable Workflows\n\n  Coming soon.\n\n  ### Internal CI Workflows\n  ...\n  ```\n\n  **変更後の構造:**\n  ```markdown\n  ## Usage\n\n  ### Reusable Workflows の利用方法\n  （既存内容をここに移動）\n\n  ### Composite Actions の利用方法（新規追加）\n\n  他のリポジトリから Composite Action を参照する場合は以下の形式を使用します:\n\n  \\```yaml\n  steps:\n    - uses: kryota-dev/actions/.github/composite/{action-name}@vX\n      with:\n        # inputs\n  \\```\n\n  ## Available Actions\n\n  ### Reusable Workflows\n\n  Coming soon.\n\n  ### Composite Actions（新規追加）\n\n  Coming soon.\n\n  ### Internal CI Workflows\n  ...（既存内容）\n  ```\n\n  **補足説明として追記する内容:**\n  - Reusable Workflows（`jobs:` 構文）と Composite Actions（`steps:` 構文）の違い\n  - バージョン指定方法（メジャータグ `v1` または完全バージョンタグ `v1.0.0`）\n\n## Data Models\n\n### action.yml の構造テンプレート\n\nComposite Action の `action.yml` は以下の構造に従う:\n\n```yaml\nname: \"{Action の表示名}\"\ndescription: \"{Action の説明}\"\n\ninputs:\n  {input-name}:\n    description: \"{入力の説明}\"\n    required: true | false\n    default: \"{デフォルト値（任意）}\"\n\noutputs:\n  {output-name}:\n    description: \"{出力の説明}\"\n    value: ${{ steps.{step-id}.outputs.{output} }}\n\nruns:\n  using: \"composite\"\n  steps:\n    - name: \"{ステップ名}\"\n      id: \"{step-id}\"\n      shell: bash\n      env:\n        INPUT_VAR: ${{ inputs.{input-name} }}  # inputs は env 経由で渡す\n      run: |\n        # シェルスクリプト\n        echo \"result=value\" >> \"$GITHUB_OUTPUT\"\n```\n\n**設計上の制約:**\n- `inputs` の値を `run` ステップに直接埋め込んではならない（テンプレートインジェクション対策）\n- 環境変数経由（`env:` キー）で渡すこと\n- Composite Actions は `secrets:` をサポートしないため、シークレットが必要な場合は `inputs:` 経由で渡す\n\n## Error Handling\n\n### エラーシナリオ\n\n1. **ls-lint: ディレクトリ名が kebab-case でない場合**\n   - **検出:** CI の ls-lint ステップがエラーを報告\n   - **対処:** ディレクトリ名を kebab-case に修正（例: `setupNode` → `setup-node`）\n\n2. **ghalint run-action: `uses:` がミュータブルタグの場合**\n   - **検出:** CI の `ghalint run-action` ステップがエラーを報告\n   - **対処:** `uses:` を full commit SHA + コメント形式に変更（例: `uses: actions/checkout@{SHA} # v4`）\n\n3. **zizmor: テンプレートインジェクション検出**\n   - **検出:** CI の zizmor ステップがエラーを報告\n   - **対処:** `${{ inputs.xxx }}` を直接 `run:` に埋め込まず、`env:` 経由で環境変数として渡す\n\n4. **actionlint: `.github/composite/` を誤って検証した場合（想定外）**\n   - **検出:** CI の actionlint ステップが `action.yml` に対してエラーを報告\n   - **対処:** `reviewdog/action-actionlint` の設定でスキャンパスを `.github/workflows/` に明示的に限定する（通常は発生しない）\n\n## Testing Strategy\n\n本機能は GitHub Actions のインフラ設定であるため、従来的な Unit / Integration / E2E テストではなく、以下のアプローチで品質を保証する。\n\n### CI による自動検証（主要テスト手段）\n\nPR 作成時に `my_test.yml` が以下を自動検証する:\n\n| ステップ | 検証内容 |\n|---|---|\n| ls-lint | `.github/composite/` 配下のディレクトリ名が kebab-case であること |\n| ghalint run-action | `action.yml` 内の `uses:` が full commit SHA でピン留めされていること |\n| zizmor | `action.yml` にテンプレートインジェクション等のセキュリティ問題がないこと |\n\n### 手動検証項目\n\n実装後に以下を手動で確認する:\n\n1. **ls-lint の動作確認**\n   - `.github/composite/` 配下に kebab-case のサブディレクトリと `action.yml` を配置し、CI が通過すること\n   - 違反ディレクトリ名（例: `setupNode`）を含む PR を作成し、CI が失敗すること\n\n2. **ghalint run-action の動作確認**\n   - SHA ピン留め済みの `action.yml` を含む PR で CI が通過すること\n   - ミュータブルタグ（`@v4`）を含む `action.yml` で CI が失敗すること\n\n3. **zizmor の自動検出確認**\n   - `uvx zizmor --format=github .` が `.github/composite/` 配下の `action.yml` をスキャン対象に含めることを確認\n\n4. **Renovate の自動更新確認**\n   - Renovate が `.github/composite/` 配下の `action.yml` 内の `uses:` を更新 PR として作成することを確認（初回 Renovate 実行後）\n\n5. **外部参照の動作確認**\n   - 別リポジトリのワークフローから `kryota-dev/actions/.github/composite/{action-name}@vX` の形式で参照し、正常に動作することを確認\n",
  "fileStats": {
    "size": 14109,
    "lines": 323,
    "lastModified": "2026-02-21T09:18:55.879Z"
  },
  "comments": []
}