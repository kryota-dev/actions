{
  "id": "snapshot_1771664526033_dbfuc507b",
  "approvalId": "approval_1771664526029_ywcc6wl2k",
  "approvalTitle": "Requirements: composite-actions-support",
  "version": 1,
  "timestamp": "2026-02-21T09:02:06.033Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\n本ドキュメントは、`kryota-dev/actions` リポジトリを Reusable Workflows に加えて **Composite Actions** も管理するリポジトリへ拡張するための要件を定義する。\n\n**As-Is（現状）:**\n- `kryota-dev/actions` は Reusable Workflows の管理リポジトリとして運用中\n- `.github/workflows/` 配下に Reusable Workflows および内部 CI ワークフローを格納\n- ls-lint により `.github/workflows/` 配下のファイルを snake_case に強制\n\n**To-Be（目標）:**\n- Reusable Workflows に加え、Composite Actions も同リポジトリで管理・公開\n- 各 Composite Action は `actions/{action-name}/action.yml` の構造で格納\n- 既存の CI パイプライン（actionlint / ls-lint / ghalint / zizmor）を Composite Actions に対応\n- README に Composite Actions の利用方法と一覧を追記\n\n**スコープの明確化:**\n- 対象: Composite Actions サポートのためのリポジトリ構造・CI・ドキュメントの拡張\n- 対象外: 個々の Composite Action の具体的な実装内容（本拡張は基盤整備のみ）\n\n## Alignment with Product Vision\n\n本リポジトリの目的は「再利用可能な GitHub Actions を一元管理・公開し、各リポジトリの CI/CD 設定の重複を排除する」ことである。Composite Actions は Reusable Workflows の補完的な存在であり、以下の価値を提供する:\n\n- **単一ジョブ内で使用可能**: Reusable Workflows はジョブ単位でしか呼び出せないが、Composite Actions はステップ単位で呼び出せるため、より細粒度な再利用が可能\n- **同一 SHA ピン留め**: 呼び出し元が指定した SHA により、Composite Action 内部のステップも同一バージョンに固定される\n\n本拡張により、管理リポジトリとしての価値がさらに高まる。\n\n---\n\n## Requirements\n\n### Requirement 1: Composite Actions のディレクトリ構造\n\n**User Story:** As a リポジトリ管理者, I want Composite Actions をリポジトリルートの `actions/` ディレクトリ配下に格納したい, so that 他リポジトリから `kryota-dev/actions/{action-name}@vX` の形式で簡潔に参照できる\n\n#### Acceptance Criteria\n\n1. WHEN 新しい Composite Action を追加するとき THEN リポジトリ SHALL `actions/{action-name}/action.yml` のディレクトリ構造で格納する\n2. WHEN `actions/{action-name}/action.yml` が存在する THEN その action.yml SHALL `using: \"composite\"` を `runs.using` フィールドに含む\n3. WHEN 外部リポジトリから Composite Action を参照するとき THEN 参照形式は `kryota-dev/actions/{action-name}@{tag-or-sha}` とする\n4. WHEN `actions/` ディレクトリが存在する THEN ディレクトリ名は kebab-case とする（例: `actions/setup-node/`）\n5. IF `action.yml` 内に `run` ステップが存在する THEN そのステップには `shell` フィールドを必ず明記する\n\n---\n\n### Requirement 2: ls-lint への Composite Actions ディレクトリの追加\n\n**User Story:** As a リポジトリ管理者, I want Composite Actions のディレクトリ・ファイル命名規則を ls-lint で自動検証したい, so that 命名の一貫性を CI で強制できる\n\n#### Acceptance Criteria\n\n1. WHEN `.ls-lint.yml` を更新するとき THEN `actions/` ディレクトリ配下の命名規則を追加する\n2. WHEN `actions/` 配下のサブディレクトリ名が kebab-case でない THEN CI SHALL ls-lint エラーを報告してチェックを失敗させる\n3. WHEN `actions/` 配下の `action.yml` ファイルが存在する THEN ls-lint SHALL そのファイルへの命名チェックを正常に通過させる\n4. WHEN PR が作成・更新されたとき THEN CI SHALL 更新後の ls-lint 設定で `actions/` ディレクトリを含む全対象ディレクトリを検証する\n\n---\n\n### Requirement 3: actionlint による Composite Actions の構文検証\n\n**User Story:** As a リポジトリ管理者, I want Composite Actions の action.yml を actionlint で構文検証したい, so that 文法ミスを早期に発見できる\n\n#### Acceptance Criteria\n\n1. WHEN PR が作成・更新されたとき THEN CI SHALL actionlint を実行して `actions/` 配下の `action.yml` も検証対象に含める\n2. WHEN actionlint が `action.yml` のエラーを検出したとき THEN CI SHALL reviewdog 経由で PR にインラインコメントを付与する\n3. IF `action.yml` の構文が正しい THEN CI SHALL actionlint のステータスチェックを通過させる\n\n---\n\n### Requirement 4: ghalint による Composite Actions のセキュリティポリシー準拠チェック\n\n**User Story:** As a リポジトリ管理者, I want Composite Actions 内の `uses:` 指定を ghalint で検証したい, so that SHA ピン留めや permission 設定の違反を自動検出できる\n\n#### Acceptance Criteria\n\n1. WHEN PR が作成・更新されたとき THEN CI SHALL ghalint を実行して `actions/` 配下の `action.yml` も検証対象に含める\n2. WHEN Composite Action 内の `uses:` がミュータブルタグ（例: `@v4`）で指定されているとき THEN ghalint SHALL エラーを報告する\n3. WHEN Composite Action 内に credential 漏洩パターンが検出されたとき THEN ghalint SHALL エラーを報告する\n\n---\n\n### Requirement 5: zizmor による Composite Actions の静的セキュリティ分析\n\n**User Story:** As a リポジトリ管理者, I want Composite Actions の action.yml を zizmor で静的セキュリティ分析したい, so that テンプレートインジェクションやサプライチェーンリスクを検出できる\n\n#### Acceptance Criteria\n\n1. WHEN PR が作成・更新されたとき THEN CI SHALL zizmor を実行して `actions/` 配下の `action.yml` も検証対象に含める\n2. WHEN テンプレートインジェクション脆弱性（例: `${{ inputs.xxx }}` の直接 `run` への埋め込み）が検出されたとき THEN zizmor SHALL エラーを報告する\n3. WHEN サプライチェーンリスクのある Action 参照が検出されたとき THEN zizmor SHALL 警告を報告する\n\n---\n\n### Requirement 6: Composite Actions の uses: full commit SHA ピン留め\n\n**User Story:** As a リポジトリ管理者, I want Composite Actions 内の `uses:` も full commit SHA でピン留めしたい, so that サプライチェーン攻撃リスクを低減できる\n\n#### Acceptance Criteria\n\n1. WHEN `action.yml` 内に `uses:` ステップが存在する THEN その指定は full commit SHA（40文字）でピン留めする\n2. WHEN Renovate Bot が設定済みのとき THEN Renovate SHALL `actions/` 配下の `action.yml` 内の `uses:` も自動更新対象に含める\n3. IF SHA ピン留めされていない `uses:` が `action.yml` 内に存在する THEN ghalint または zizmor SHALL CI でエラーを報告する\n\n---\n\n### Requirement 7: タグベースのリリース管理との整合\n\n**User Story:** As a Composite Action の利用者, I want 既存の tagpr ベースのバージョニング（`v1`, `v1.0.0` 等）で Composite Actions を参照したい, so that Reusable Workflows と同じバージョン管理規則で一貫して利用できる\n\n#### Acceptance Criteria\n\n1. WHEN tagpr が新しいリリースタグ（例: `v1.2.0`）を作成するとき THEN そのタグは Composite Actions にも適用される\n2. WHEN メジャーバージョンタグ（例: `v1`）が更新されるとき THEN Composite Actions への参照も自動的に最新バージョンに追従する\n3. WHEN 外部リポジトリが `kryota-dev/actions/{action-name}@v1` の形式で参照するとき THEN 最新のメジャーバージョンに対応した Composite Action が提供される\n4. WHEN 既存の tagpr・リリース設定（`.tagpr`, `my_release.yml`, `.github/release.yml`）が存在する THEN それらの設定変更は不要とする（既存設定でリポジトリ全体のリリースが管理される）\n\n---\n\n### Requirement 8: README の更新\n\n**User Story:** As a Composite Action の利用者, I want README から利用可能な Composite Actions と使い方をすぐに把握したい, so that 目的の Action を迷わず使い始めることができる\n\n#### Acceptance Criteria\n\n1. WHEN `README.md` を更新するとき THEN 「Available Workflows」セクションに「Composite Actions」サブセクションを追加する\n2. WHEN Composite Action のサブセクションが存在する THEN 外部リポジトリからの参照方法（`uses: kryota-dev/actions/{action-name}@vX`）のサンプルを含める\n3. WHEN 現時点で公開済みの Composite Action が存在しない THEN 「Coming soon.」または空の一覧プレースホルダーを記載する（将来の Action 追加時に更新する）\n4. WHEN `README.md` に Reusable Workflows の参照方法（`uses:` + `jobs:` 構文）が記載されている THEN Composite Actions の参照方法（`uses:` + `steps:` 構文）との違いも明記する\n\n---\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Single Responsibility Principle**: 各 Composite Action は単一の目的に特化し、複数の責務を持たせない\n- **Modular Design**: `actions/` ディレクトリ配下に Action ごとのサブディレクトリを設け、Reusable Workflows（`.github/workflows/`）と明確に分離する\n- **Dependency Management**: Composite Action 内の `uses:` は Renovate Bot により自動更新管理する\n- **Clear Interfaces**: `action.yml` には `inputs`・`outputs`・`description` を明示的に定義し、利用者への明確なインターフェースを提供する\n\n### Performance\n\n- Composite Actions は Reusable Workflows と異なり呼び出し元ジョブ内で実行されるため、ジョブ起動オーバーヘッドが発生しない\n- CI の lint ジョブ（`my_test.yml`）は既存の単一ジョブ構成を維持し、不要なジョブ分割を避ける\n\n### Security\n\n- Composite Action 内の全 `uses:` は **full commit SHA（40文字）でピン留め**する\n- ghalint と zizmor により Composite Actions のセキュリティポリシー違反を CI で自動検出する\n- Composite Action への入力値（`inputs`）は `run` ステップへの直接埋め込みを避け、環境変数経由で渡すことでテンプレートインジェクションリスクを排除する\n- `action.yml` にシークレットをハードコードしない\n\n### Reliability\n\n- `my_test.yml` の CI パイプラインが `actions/` 配下の `action.yml` も検証対象に含めることで、品質ゲートの抜け漏れを防ぐ\n- 既存の Reusable Workflows への影響を与えないこと（後方互換性の維持）\n\n### Usability\n\n- Composite Actions のディレクトリ名は kebab-case で命名し、Action の目的が名前から直感的に分かるようにする\n- 外部リポジトリからの参照形式 `kryota-dev/actions/{action-name}@vX` は簡潔で覚えやすい構造とする\n- `action.yml` には `name` と `description` を必ず記載し、GitHub UI での視認性を確保する\n\n---\n\n## Out of Scope\n\n以下は今回のスコープ外とする:\n\n- 個々の Composite Action（例: `actions/setup-node/action.yml` 等）の具体的な実装内容（本拡張は基盤整備のみ）\n- Reusable Workflows の新規追加・変更\n- 既存の内部 CI ワークフロー（`my_test.yml`, `my_release.yml` 等）の動作変更\n- GitHub リポジトリの Web UI 設定の変更（Branch Protection Rules 等）\n- Docker Action や JavaScript Action のサポート（Composite Actions のみ対象）\n",
  "fileStats": {
    "size": 11863,
    "lines": 179,
    "lastModified": "2026-02-21T09:01:05.629Z"
  },
  "comments": []
}