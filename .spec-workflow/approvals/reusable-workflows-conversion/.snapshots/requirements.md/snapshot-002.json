{
  "id": "snapshot_1771861096790_mn9z3el42",
  "approvalId": "approval_1771861033411_tpzt92sbk",
  "approvalTitle": "Requirements: 4つの内部CIワークフローをReusable Workflowsに変換",
  "version": 2,
  "timestamp": "2026-02-23T15:38:16.789Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\n本ドキュメントは、`kryota-dev/actions` リポジトリの4つの内部 CI ワークフロー（`my-codeql.yml`、`my-release.yml`、`my-setup-pr.yml`、`my-test.yml`）を、外部リポジトリから呼び出し可能な Reusable Workflows として公開するための要件を定義する。\n\n### 背景\n\n現在、これらのワークフローは `kryota-dev/actions` リポジトリの内部 CI としてのみ機能している。しかし、CodeQL スキャン、tagpr リリース管理、PR assignee 自動設定、品質ゲート（actionlint / ls-lint / ghalint / zizmor）といった処理は、他のリポジトリでも共通的に必要とされるパターンである。\n\nこれらを Reusable Workflows として公開することで、各リポジトリの CI/CD 設定の重複を排除し、メンテナンスコストを削減する。\n\n### スコープ\n\n- **対象**: 4つの内部 CI ワークフローに対応する Reusable Workflow の新規作成\n- **対象外**: 既存の内部 CI ワークフロー（`my-*`）のリファクタリング（Reusable Workflow 呼び出しへの変換は別途検討）\n\n## Alignment with Product Vision\n\n本リポジトリは「再利用可能な GitHub Actions を一元管理・公開する」ことを目的としている。現在 Composite Actions は4つ公開されているが、Reusable Workflows は \"Coming soon.\" の状態であり、本対応によりリポジトリの主要目的の一つを実現する。\n\n---\n\n## Requirements\n\n### Requirement 1: CodeQL Reusable Workflow の公開\n\n**User Story:** As a 外部リポジトリの管理者, I want CodeQL セキュリティスキャンを Reusable Workflow として呼び出したい, so that 各リポジトリで CodeQL の設定を繰り返す必要がなくなる\n\n#### Acceptance Criteria\n\n1. WHEN 外部リポジトリが `workflow_call` で呼び出したとき THEN Reusable Workflow SHALL CodeQL の init と analyze を実行する\n2. WHEN `languages` 入力が指定されたとき THEN Reusable Workflow SHALL 指定された言語でスキャンを実行する\n3. IF `languages` 入力が省略されたとき THEN Reusable Workflow SHALL デフォルト値 `actions` でスキャンを実行する\n4. WHEN スキャンが実行されたとき THEN Reusable Workflow SHALL `security-events: write` パーミッションで結果を SARIF として GitHub にアップロードする\n\n---\n\n### Requirement 2: Release Reusable Workflow の公開\n\n**User Story:** As a 外部リポジトリの管理者, I want tagpr によるリリース管理を Reusable Workflow として呼び出したい, so that セマンティックバージョニングとメジャータグ更新を各リポジトリで再実装する必要がなくなる\n\n#### Acceptance Criteria\n\n1. WHEN 外部リポジトリが `workflow_call` で呼び出したとき THEN Reusable Workflow SHALL tagpr によるリリース PR の自動作成・管理を実行する\n2. WHEN tagpr が新しいタグを生成したとき THEN Reusable Workflow SHALL メジャータグ（例: `v1`）を最新リリースに自動更新する\n3. WHEN Reusable Workflow が呼び出されるとき THEN 呼び出し元 SHALL `app-token` シークレットを渡す必要がある\n4. WHEN tagpr と bump_major_tag ジョブが実行されるとき THEN Reusable Workflow SHALL concurrency 制御によりリリースの競合を防止する\n\n---\n\n### Requirement 3: Setup PR Reusable Workflow の公開\n\n**User Story:** As a 外部リポジトリの管理者, I want PR 作成時の assignee 自動設定を Reusable Workflow として呼び出したい, so that 各リポジトリで同じ自動化スクリプトを書く必要がなくなる\n\n#### Acceptance Criteria\n\n1. WHEN 外部リポジトリが `workflow_call` で呼び出したとき THEN Reusable Workflow SHALL PR 作成者を自動的に assignee に設定する\n2. WHEN Reusable Workflow が呼び出されるとき THEN 呼び出し元 SHALL PR の URL と actor 情報を入力として渡す\n3. WHEN assignee の設定が完了したとき THEN Reusable Workflow SHALL `pull-requests: write` パーミッションのみで動作する\n\n---\n\n### Requirement 4: Test (品質ゲート) Reusable Workflow の公開\n\n**User Story:** As a 外部リポジトリの管理者, I want GitHub Actions ワークフローの品質ゲート（actionlint / ls-lint / ghalint / zizmor）を Reusable Workflow として呼び出したい, so that 品質チェックツールのセットアップを各リポジトリで繰り返す必要がなくなる\n\n#### Acceptance Criteria\n\n1. WHEN 外部リポジトリが `workflow_call` で呼び出したとき THEN Reusable Workflow SHALL actionlint、ls-lint、ghalint、zizmor を実行する\n2. WHEN actionlint がエラーを検出したとき THEN Reusable Workflow SHALL reviewdog 経由で PR にインラインコメントを付与する\n3. WHEN ghalint がセキュリティポリシー違反を検出したとき THEN Reusable Workflow SHALL エラーを報告してチェックを失敗させる\n4. WHEN zizmor が脆弱性を検出したとき THEN Reusable Workflow SHALL エラーを報告してチェックを失敗させる\n5. WHEN `aqua-version` 入力が指定されたとき THEN Reusable Workflow SHALL 指定されたバージョンの aqua を使用する\n6. IF `aqua-version` 入力が省略されたとき THEN Reusable Workflow SHALL デフォルトの aqua バージョンを使用する\n\n---\n\n### Requirement 5: Reusable Workflow の命名規則と配置\n\n**User Story:** As a リポジトリ管理者, I want Reusable Workflow が既存の命名規則・配置ルールに従っていること, so that プロジェクトの一貫性が維持される\n\n#### Acceptance Criteria\n\n1. WHEN Reusable Workflow が作成されるとき THEN ファイル名 SHALL kebab-case で命名される（`my-` プレフィックスなし）\n2. WHEN Reusable Workflow が配置されるとき THEN ファイル SHALL `.github/workflows/` ディレクトリに格納される\n3. WHEN Reusable Workflow の `uses:` ディレクティブが記述されるとき THEN 全ての Action 参照 SHALL full commit SHA（40文字）でピン留めされ、タグをコメントで記載する\n4. WHEN Reusable Workflow が作成されるとき THEN 各ジョブ SHALL `timeout-minutes` を設定する\n5. WHEN Reusable Workflow が作成されるとき THEN トップレベル SHALL `permissions: {}` を設定し、各ジョブで最小権限のみ付与する\n\n---\n\n### Requirement 6: ドキュメントの更新\n\n**User Story:** As a Reusable Workflow の利用者, I want README から利用可能な Reusable Workflow とその使い方を確認したい, so that 各ワークフローを迷わず使い始めることができる\n\n#### Acceptance Criteria\n\n1. WHEN Reusable Workflow が公開されたとき THEN README SHALL 各 Reusable Workflow の名前・用途・入力パラメータ・使用例を記載する\n2. WHEN README の Reusable Workflows セクションが更新されるとき THEN \"Coming soon.\" の記載 SHALL 実際のワークフロー一覧に置き換えられる\n\n---\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Single Responsibility Principle**: 各 Reusable Workflow は単一の CI/CD 目的に特化する\n- **Modular Design**: 内部 CI（`my-*`）と公開 Reusable Workflow は別ファイルとして分離する\n- **Clear Interfaces**: `workflow_call` の `inputs` / `secrets` を明示的に定義し、必須・任意・デフォルト値を明確にする\n- **Dependency Management**: Reusable Workflow 内の Action 参照も Renovate Bot による自動更新の対象とする\n\n### Performance\n\n- Reusable Workflow は呼び出し元のジョブとは別ジョブとして実行されるため、必要最小限のステップ構成とする\n- `timeout-minutes` を全ジョブに設定し、異常実行の長時間化を防止する\n\n### Security\n\n- 全ての `uses:` は full commit SHA（40文字）でピン留めする\n- `permissions: {}` をトップレベルに設定し、各ジョブで最小権限のみ付与する\n- シークレットは `secrets:` キーワードで明示的に渡す（`secrets: inherit` は使用しない方針を推奨）\n- テンプレートインジェクション対策として、`inputs` の値は `env:` 経由で環境変数として渡す\n\n### Reliability\n\n- Reusable Workflow は `kryota-dev/actions` リポジトリのバージョンタグ（例: `@v1`）で参照され、メジャータグは最新リリースに追従する\n- concurrency 制御により、同一リファレンスに対する並列実行の競合を防止する\n\n### Usability\n\n- 全ての `inputs` と `secrets` に `description` を記載し、利用者が GitHub UI からパラメータの意味を把握できるようにする\n- デフォルト値を適切に設定し、最小構成での呼び出しを可能にする\n\n---\n\n## Out of Scope\n\n以下は本スコープ外とする:\n\n- 既存の内部 CI ワークフロー（`my-*`）を Reusable Workflow 呼び出しにリファクタリングすること\n- Reusable Workflow 以外の新機能追加\n- 外部リポジトリでの E2E テスト\n",
  "fileStats": {
    "size": 9339,
    "lines": 144,
    "lastModified": "2026-02-23T15:37:07.770Z"
  },
  "comments": []
}