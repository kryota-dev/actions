{
  "id": "snapshot_1771861522202_3wzp9mrru",
  "approvalId": "approval_1771861331965_93rer8r2w",
  "approvalTitle": "Design: 4つのReusable Workflowsの技術設計",
  "version": 2,
  "timestamp": "2026-02-23T15:45:22.202Z",
  "trigger": "revision_requested",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\n本ドキュメントは、`kryota-dev/actions` リポジトリの4つの内部 CI ワークフローに対応する Reusable Workflows を新規作成するための技術設計を定義する。\n\n変更の全体像:\n\n1. **`codeql.yml`** — CodeQL セキュリティスキャンの Reusable Workflow を新規作成\n2. **`release.yml`** — tagpr リリース管理 + メジャータグ更新の Reusable Workflow を新規作成\n3. **`setup-pr.yml`** — PR assignee 自動設定の Reusable Workflow を新規作成\n4. **`test.yml`** — 品質ゲート（actionlint / ls-lint / ghalint / zizmor）の Reusable Workflow を新規作成\n5. **`README.md`** — Reusable Workflows セクションを更新\n\n既存の内部 CI ワークフロー（`my-*`）は変更しない。\n\n## Steering Document Alignment\n\n### 技術基準（既存コーディング規約）\n\n- `uses:` は full commit SHA（40文字）でピン留め（`ghalint` / `zizmor` で CI 検証）\n- Renovate Bot により SHA を自動更新\n- `permissions: {}` をトップレベルに設定し、各 job で最小権限のみ付与\n- `timeout-minutes` を全 job に設定\n\n### プロジェクト構造規約\n\n- Reusable Workflows: `.github/workflows/` 配下、kebab-case、`my-` プレフィックスなし\n- 内部 CI: `.github/workflows/` 配下、kebab-case、`my-` プレフィックス付き\n- ls-lint で命名規則を自動検証\n\n## Code Reuse Analysis\n\n### 既存コンポーネントの活用\n\n| コンポーネント | 活用方法 |\n|---|---|\n| `my-codeql.yml` | ロジックをそのまま Reusable Workflow に移植。`languages` を入力パラメータ化 |\n| `my-release.yml` | ロジックをそのまま Reusable Workflow に移植。`APP_TOKEN` を `app-token` シークレットとして受け取る |\n| `my-setup-pr.yml` | ロジックをそのまま Reusable Workflow に移植。`github` コンテキストの継承を活用 |\n| `my-test.yml` | ロジックをそのまま Reusable Workflow に移植。`aqua-version` 等を入力パラメータ化 |\n| `renovate.json5` | Reusable Workflow 内の `uses:` も `.github/workflows/` 配下にあるため、Renovate の自動更新対象となる。**追加設定不要** |\n\n### Reusable Workflow 内での github コンテキストの動作\n\nReusable Workflow では、`github` コンテキストは呼び出し元（caller）のコンテキストを継承する。つまり:\n\n- `github.event` — 呼び出し元のトリガーイベントのペイロード\n- `github.actor` — 呼び出し元ワークフローをトリガーしたユーザー\n- `github.repository` — 呼び出し元リポジトリ\n- `github.token` / `secrets.GITHUB_TOKEN` — 呼び出し元の自動トークン（自動付与）\n\nこの性質により、`setup-pr.yml` では `github.event.pull_request.html_url` や `github.actor` を入力パラメータとせずに直接参照できる。\n\n### 変更が必要なファイル\n\n| ファイル | 変更種別 | 変更内容 |\n|---|---|---|\n| `.github/workflows/codeql.yml` | 新規作成 | CodeQL Reusable Workflow |\n| `.github/workflows/release.yml` | 新規作成 | Release Reusable Workflow |\n| `.github/workflows/setup-pr.yml` | 新規作成 | Setup PR Reusable Workflow |\n| `.github/workflows/test.yml` | 新規作成 | Test (品質ゲート) Reusable Workflow |\n| `README.md` | 修正 | Reusable Workflows セクションの更新 |\n\n### 変更が不要なファイル\n\n| ファイル | 理由 |\n|---|---|\n| `.github/workflows/my-codeql.yml` | 内部 CI はそのまま維持 |\n| `.github/workflows/my-release.yml` | 内部 CI はそのまま維持 |\n| `.github/workflows/my-setup-pr.yml` | 内部 CI はそのまま維持 |\n| `.github/workflows/my-test.yml` | 内部 CI はそのまま維持 |\n| `.ls-lint.yml` | 新ファイルは kebab-case に準拠しており変更不要 |\n| `renovate.json5` | `.github/workflows/` 配下の `uses:` は自動検出対象 |\n\n## Architecture\n\n### ディレクトリ構造（To-Be）\n\n```\n.github/\n  workflows/\n    codeql.yml              # 新規: CodeQL Reusable Workflow\n    release.yml             # 新規: Release Reusable Workflow\n    setup-pr.yml            # 新規: Setup PR Reusable Workflow\n    test.yml                # 新規: Test Reusable Workflow\n    my-codeql.yml           # 既存: 変更なし\n    my-release.yml          # 既存: 変更なし\n    my-setup-pr.yml         # 既存: 変更なし\n    my-test.yml             # 既存: 変更なし\n  composite/                # 既存: 変更なし\n    pnpm-setup/\n    playwright-setup/\n    slack-notify-success/\n    slack-notify-failure/\nREADME.md                   # 既存: Reusable Workflows セクション更新\n```\n\n### 全体アーキテクチャ\n\n```mermaid\ngraph TD\n    subgraph \"External Repository (Caller)\"\n        EXT_PR[PR / push / etc.] -->|workflow_call| CALL[Reusable Workflow 呼び出し]\n    end\n\n    subgraph \"kryota-dev/actions (Reusable Workflows)\"\n        CALL --> CODEQL[codeql.yml<br/>CodeQL スキャン]\n        CALL --> RELEASE[release.yml<br/>tagpr + メジャータグ更新]\n        CALL --> SETUP_PR[setup-pr.yml<br/>PR assignee 自動設定]\n        CALL --> TEST[test.yml<br/>actionlint / ls-lint /<br/>ghalint / zizmor]\n    end\n\n    subgraph \"kryota-dev/actions (Internal CI)\"\n        INT_TRIGGER[PR / push / merge_group] --> MY_CODEQL[my-codeql.yml]\n        INT_TRIGGER --> MY_RELEASE[my-release.yml]\n        INT_TRIGGER --> MY_SETUP_PR[my-setup-pr.yml]\n        INT_TRIGGER --> MY_TEST[my-test.yml]\n    end\n\n    subgraph \"Quality Tools\"\n        TEST --> ACTIONLINT[actionlint<br/>構文チェック]\n        TEST --> LSLINT[ls-lint<br/>命名規則チェック]\n        TEST --> GHALINT_RUN[ghalint run<br/>Workflow セキュリティ]\n        TEST --> GHALINT_ACTION[ghalint run-action<br/>Action セキュリティ]\n        TEST --> ZIZMOR[zizmor<br/>静的セキュリティ分析]\n    end\n```\n\n### Reusable Workflow のインターフェース設計方針\n\n1. **入力の最小化**: `github` コンテキストが継承されるため、コンテキストから取得可能な値は入力パラメータにしない\n2. **デフォルト値の提供**: 全ての任意入力にデフォルト値を設定し、最小構成での呼び出しを可能にする\n3. **シークレットの明示的定義**: `secrets: inherit` は使用せず、必要なシークレットを `secrets:` で明示的に定義する\n4. **出力の提供**: 後続処理に必要な値（リリースタグ等）は `outputs` で公開する\n\n---\n\n## Components and Interfaces\n\n### Component 1: `codeql.yml` — CodeQL Reusable Workflow\n\n- **Purpose:** CodeQL セキュリティスキャンを外部リポジトリから呼び出し可能にする\n- **トリガー:** `workflow_call`\n\n**インターフェース:**\n\n| 種別 | 名前 | 型 | 必須 | デフォルト | 説明 |\n|---|---|---|---|---|---|\n| input | `languages` | string | No | `'[\"actions\"]'` | スキャン対象言語の JSON 配列 |\n\n**設計詳細:**\n\n```yaml\nname: CodeQL\n\non:\n  workflow_call:\n    inputs:\n      languages:\n        description: \"JSON array of languages to analyze (e.g., '[\\\"javascript\\\", \\\"typescript\\\"]')\"\n        type: string\n        required: false\n        default: '[\"actions\"]'\n\npermissions: {}\n\njobs:\n  analyze:\n    runs-on: ubuntu-latest\n    timeout-minutes: 15\n    permissions:\n      actions: read\n      contents: read\n      security-events: write\n    strategy:\n      matrix:\n        language: ${{ fromJSON(inputs.languages) }}\n    steps:\n      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6\n        with:\n          persist-credentials: false\n\n      - uses: github/codeql-action/init@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4.32.4\n        with:\n          languages: ${{ matrix.language }}\n\n      - uses: github/codeql-action/analyze@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4.32.4\n```\n\n- **Dependencies**: `actions/checkout`, `github/codeql-action/init`, `github/codeql-action/analyze`\n- **呼び出し元の前提条件**: なし（CodeQL はリポジトリのコードを自動解析する）\n\n**呼び出し例:**\n\n```yaml\njobs:\n  codeql:\n    uses: kryota-dev/actions/.github/workflows/codeql.yml@v1\n    # デフォルトで actions 言語をスキャン\n\n  codeql-js:\n    uses: kryota-dev/actions/.github/workflows/codeql.yml@v1\n    with:\n      languages: '[\"javascript\", \"typescript\"]'\n```\n\n---\n\n### Component 2: `release.yml` — Release Reusable Workflow\n\n- **Purpose:** tagpr によるリリース管理とメジャータグ更新を外部リポジトリから呼び出し可能にする\n- **トリガー:** `workflow_call`\n\n**インターフェース:**\n\n| 種別 | 名前 | 型 | 必須 | デフォルト | 説明 |\n|---|---|---|---|---|---|\n| secret | `app-token` | secret | Yes | - | tagpr 用 PAT（`repo` + `workflow` スコープ必要） |\n| output | `tag` | string | - | - | tagpr が生成したバージョンタグ（リリースなしの場合は空文字列） |\n\n**設計詳細:**\n\n```yaml\nname: Release\n\non:\n  workflow_call:\n    secrets:\n      app-token:\n        description: \"Personal Access Token for tagpr (requires 'repo' and 'workflow' scopes)\"\n        required: true\n    outputs:\n      tag:\n        description: \"The version tag created by tagpr (empty if no release)\"\n        value: ${{ jobs.tagpr.outputs.tag }}\n\nconcurrency:\n  group: ${{ github.workflow }}-release\n  cancel-in-progress: false\n\npermissions: {}\n\njobs:\n  tagpr:\n    runs-on: ubuntu-latest\n    timeout-minutes: 10\n    permissions:\n      contents: write\n      pull-requests: write\n    outputs:\n      tag: ${{ steps.tagpr.outputs.tag }}\n    steps:\n      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6\n        with:\n          token: ${{ secrets.app-token }}\n          persist-credentials: false\n\n      - uses: Songmu/tagpr@da82ed6743aec90049892070edd5561335904a9e # v1.17.0\n        id: tagpr\n        env:\n          GITHUB_TOKEN: ${{ secrets.app-token }}\n\n  bump_major_tag:\n    needs: tagpr\n    if: needs.tagpr.outputs.tag != ''\n    runs-on: ubuntu-latest\n    timeout-minutes: 5\n    permissions:\n      contents: write\n    steps:\n      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6\n        with:\n          token: ${{ secrets.app-token }}\n          persist-credentials: false\n\n      - name: Update major tag\n        env:\n          TAG: ${{ needs.tagpr.outputs.tag }}\n          GITHUB_TOKEN: ${{ secrets.app-token }}\n          REPO: ${{ github.repository }}\n        run: |\n          git remote set-url origin \"https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.git\"\n          MAJOR=\"${TAG%%.*}\"\n          git tag -f \"$MAJOR\"\n          git push origin \"$MAJOR\" --force\n```\n\n- **Dependencies**: `actions/checkout`, `Songmu/tagpr`\n- **Secrets**: `app-token`（PAT: Branch Protection をバイパスするために `GITHUB_TOKEN` ではなく PAT が必要）\n- **呼び出し元の前提条件**: `.tagpr` 設定ファイルが存在すること、`APP_TOKEN` シークレットが設定されていること\n\n**concurrency 設計:**\n\n- `group: ${{ github.workflow }}-release` — 呼び出し元ワークフロー名 + `-release` サフィックスでグループ化\n- `cancel-in-progress: false` — リリース処理は中断せず完了を待つ\n- Reusable Workflow の concurrency は呼び出し元とは独立してスコープされるため、呼び出し元の他のジョブに影響しない\n\n**呼び出し例:**\n\n```yaml\njobs:\n  release:\n    uses: kryota-dev/actions/.github/workflows/release.yml@v1\n    secrets:\n      app-token: ${{ secrets.APP_TOKEN }}\n```\n\n---\n\n### Component 3: `setup-pr.yml` — Setup PR Reusable Workflow\n\n- **Purpose:** PR 作成時に作成者を自動的に assignee に設定する処理を外部リポジトリから呼び出し可能にする\n- **トリガー:** `workflow_call`\n\n**インターフェース:**\n\n| 種別 | 名前 | 型 | 必須 | デフォルト | 説明 |\n|---|---|---|---|---|---|\n| (なし) | - | - | - | - | `github` コンテキストから全ての情報を取得 |\n\n**設計詳細:**\n\n```yaml\nname: Setup PR\n\non:\n  workflow_call: {}\n\npermissions: {}\n\njobs:\n  add_assignee:\n    runs-on: ubuntu-latest\n    timeout-minutes: 5\n    permissions:\n      pull-requests: write\n    steps:\n      - name: Add assignee\n        run: gh pr edit \"$PR_URL\" --add-assignee \"$ACTOR\"\n        env:\n          GH_TOKEN: ${{ github.token }}\n          PR_URL: ${{ github.event.pull_request.html_url }}\n          ACTOR: ${{ github.actor }}\n```\n\n- **Dependencies**: GitHub CLI（`ubuntu-latest` にプリインストール、`checkout` 不要）\n- **呼び出し元の前提条件**: `pull_request: types: [opened]` でトリガーされること（`github.event.pull_request` が存在する必要がある）\n- **github コンテキストの継承**: `github.event.pull_request.html_url` と `github.actor` は呼び出し元から自動的に継承される\n\n**呼び出し例:**\n\n```yaml\non:\n  pull_request:\n    types: [opened]\n\njobs:\n  setup-pr:\n    uses: kryota-dev/actions/.github/workflows/setup-pr.yml@v1\n```\n\n---\n\n### Component 4: `test.yml` — Test (品質ゲート) Reusable Workflow\n\n- **Purpose:** GitHub Actions ワークフローの品質ゲート（actionlint / ls-lint / ghalint / zizmor）を外部リポジトリから呼び出し可能にする\n- **トリガー:** `workflow_call`\n\n**インターフェース:**\n\n| 種別 | 名前 | 型 | 必須 | デフォルト | 説明 |\n|---|---|---|---|---|---|\n| input | `aqua-version` | string | No | `v2.56.6` | aqua のバージョン |\n| input | `reviewdog-reporter` | string | No | `github-pr-review` | reviewdog のレポーター種別 |\n\n**設計詳細:**\n\n```yaml\nname: Test\n\non:\n  workflow_call:\n    inputs:\n      aqua-version:\n        description: \"Version of aqua to install for ghalint\"\n        type: string\n        required: false\n        default: \"v2.56.6\"\n      reviewdog-reporter:\n        description: \"Reporter type for reviewdog/actionlint (github-pr-review, github-check, etc.)\"\n        type: string\n        required: false\n        default: \"github-pr-review\"\n\npermissions: {}\n\njobs:\n  lint:\n    runs-on: ubuntu-latest\n    timeout-minutes: 10\n    permissions:\n      contents: read\n      pull-requests: write\n    steps:\n      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6\n        with:\n          persist-credentials: false\n\n      - uses: reviewdog/action-actionlint@0d952c597ef8459f634d7145b0b044a9699e5e43 # v1.71.0\n        with:\n          reporter: ${{ inputs.reviewdog-reporter }}\n\n      - uses: ls-lint/action@02e380fe8733d499cbfc9e22276de5085508a5bd # v2.3.1\n\n      - uses: aquaproj/aqua-installer@11dd79b4e498d471a9385aa9fb7f62bb5f52a73c # v4.0.4\n        with:\n          aqua_version: ${{ inputs.aqua-version }}\n\n      - run: echo \"${AQUA_ROOT_DIR:-${HOME}/.local/share/aquaproj-aqua}/bin\" >> \"$GITHUB_PATH\"\n        shell: bash\n\n      - name: Run ghalint\n        run: ghalint run\n        shell: bash\n\n      - name: Run ghalint run-action\n        run: ghalint run-action\n        shell: bash\n\n      - uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0\n\n      - name: Run zizmor\n        run: uvx zizmor --format=github .\n        env:\n          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n```\n\n- **Dependencies**: `actions/checkout`, `reviewdog/action-actionlint`, `ls-lint/action`, `aquaproj/aqua-installer`, `astral-sh/setup-uv`\n- **呼び出し元の前提条件:**\n  - `.ls-lint.yml` が存在すること（ls-lint の設定）\n  - `aqua.yaml` が存在し、`ghalint` が定義されていること（ghalint のインストール）\n  - `.github/workflows/` にワークフローファイルが存在すること（actionlint / ghalint の検証対象）\n- **`secrets.GITHUB_TOKEN` について**: Reusable Workflow では呼び出し元の `GITHUB_TOKEN` が自動的に利用可能。明示的なシークレット定義は不要\n\n**呼び出し例:**\n\n```yaml\njobs:\n  test:\n    uses: kryota-dev/actions/.github/workflows/test.yml@v1\n    # デフォルト設定で実行\n\n  test-custom:\n    uses: kryota-dev/actions/.github/workflows/test.yml@v1\n    with:\n      aqua-version: \"v2.60.0\"\n      reviewdog-reporter: \"github-check\"\n```\n\n---\n\n### Component 5: `README.md` の更新\n\n- **Purpose:** Reusable Workflows セクションの \"Coming soon.\" を実際のワークフロー一覧に置き換える\n- **変更箇所:** `## Available Workflows` → `### Reusable Workflows` セクション\n\n**更新後の構造:**\n\n```markdown\n### Reusable Workflows\n\n#### codeql\n\nCodeQL によるセキュリティスキャンを実行します。\n\n| 入力名 | 必須 | デフォルト値 | 説明 |\n|---|---|---|---|\n| `languages` | 任意 | `'[\"actions\"]'` | スキャン対象言語の JSON 配列 |\n\n(使用例を記載)\n\n#### release\n\ntagpr によるリリース管理とメジャータグ更新を実行します。\n\n| シークレット名 | 必須 | 説明 |\n|---|---|---|\n| `app-token` | 必須 | tagpr 用 PAT |\n\n| 出力名 | 説明 |\n|---|---|\n| `tag` | 生成されたバージョンタグ |\n\n(使用例を記載)\n\n#### setup-pr\n\nPR 作成者を自動的に assignee に設定します。\n\n(使用例を記載)\n\n#### test\n\nGitHub Actions ワークフローの品質ゲートを実行します。\n\n| 入力名 | 必須 | デフォルト値 | 説明 |\n|---|---|---|---|\n| `aqua-version` | 任意 | `v2.56.6` | aqua バージョン |\n| `reviewdog-reporter` | 任意 | `github-pr-review` | reviewdog レポーター種別 |\n\n(使用例を記載)\n```\n\n## Data Models\n\n### Reusable Workflow のインターフェースマトリクス\n\n| ワークフロー | inputs | secrets | outputs |\n|---|---|---|---|\n| `codeql.yml` | `languages` (任意) | なし | なし |\n| `release.yml` | なし | `app-token` (必須) | `tag` |\n| `setup-pr.yml` | なし | なし | なし |\n| `test.yml` | `aqua-version` (任意), `reviewdog-reporter` (任意) | なし | なし |\n\n### 呼び出し元の前提条件マトリクス\n\n| ワークフロー | 必須設定ファイル | 必須シークレット | 推奨トリガー |\n|---|---|---|---|\n| `codeql.yml` | なし | なし | `push` (main), `pull_request`, `merge_group` |\n| `release.yml` | `.tagpr` | `APP_TOKEN` | `push` (main) |\n| `setup-pr.yml` | なし | なし | `pull_request: types: [opened]` |\n| `test.yml` | `.ls-lint.yml`, `aqua.yaml` (ghalint 定義含む) | なし | `pull_request`, `merge_group` |\n\n## Error Handling\n\n### Error Scenarios\n\n1. **呼び出し元のトリガーと Reusable Workflow の不整合**\n   - **Handling:** `setup-pr.yml` を `pull_request` 以外のトリガーから呼び出すと、`github.event.pull_request` が存在せず失敗する\n   - **User Impact:** ワークフロー実行が失敗し、エラーログに null reference が表示される\n   - **対処:** README に推奨トリガーを明記し、利用者の設定ミスを防止する\n\n2. **release.yml の `app-token` シークレット未設定**\n   - **Handling:** tagpr が認証エラーで失敗する\n   - **User Impact:** リリースジョブが失敗し、PR 作成やタグ付けができない\n   - **対処:** `required: true` を設定し、呼び出し時にシークレット未指定で即エラーにする\n\n3. **test.yml の呼び出し元に `aqua.yaml` が存在しない場合**\n   - **Handling:** `aqua-installer` は正常に動作するが、ghalint がインストールされず `ghalint run` でコマンド未発見エラーになる\n   - **User Impact:** lint ジョブが失敗する\n   - **対処:** README に前提条件を明記する\n\n4. **test.yml の呼び出し元に `.ls-lint.yml` が存在しない場合**\n   - **Handling:** ls-lint が設定ファイル未発見で失敗する\n   - **User Impact:** lint ジョブが失敗する\n   - **対処:** README に前提条件を明記する\n\n5. **SHA ピン留め違反（Renovate 更新前）**\n   - **Handling:** ghalint / zizmor が CI でエラーを報告する\n   - **User Impact:** Reusable Workflow 自体の CI（`my-test.yml`）が失敗する\n   - **対処:** 全ての `uses:` を既存の内部 CI と同一の SHA で記述する。Renovate が自動で更新を管理する\n\n## Testing Strategy\n\n### CI による自動検証（主要テスト手段）\n\nReusable Workflow ファイル自体は `.github/workflows/` 配下に配置されるため、既存の `my-test.yml` CI パイプラインが自動的に以下を検証する:\n\n| ツール | 検証内容 |\n|---|---|\n| actionlint | Reusable Workflow の構文チェック（`workflow_call` トリガーをサポート） |\n| ls-lint | ファイル名が kebab-case であること |\n| ghalint run | `uses:` が full commit SHA でピン留めされていること、`permissions` が適切であること |\n| zizmor | テンプレートインジェクション等のセキュリティ問題がないこと |\n\n### 手動検証項目\n\n1. **各 Reusable Workflow の呼び出しテスト**\n   - 別リポジトリから各 Reusable Workflow を `workflow_call` で呼び出し、正常に動作することを確認\n   - 入力パラメータのデフォルト値で動作すること\n   - 入力パラメータをカスタマイズして動作すること\n\n2. **`release.yml` の concurrency 検証**\n   - 同時に複数のプッシュが発生した場合に、リリース処理が競合しないことを確認\n\n3. **`setup-pr.yml` の github コンテキスト継承検証**\n   - 呼び出し元の `pull_request` イベントから `github.event.pull_request.html_url` と `github.actor` が正しく取得できることを確認\n\n4. **Renovate の自動更新確認**\n   - 新しい Reusable Workflow ファイル内の `uses:` が Renovate の更新対象として認識されることを確認\n",
  "fileStats": {
    "size": 21875,
    "lines": 592,
    "lastModified": "2026-02-23T15:42:06.640Z"
  },
  "comments": []
}